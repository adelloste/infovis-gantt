"use strict";function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,r)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach((function(e){_defineProperty(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function uuidv4(){var t=crypto.getRandomValues(new Uint16Array(8)),e=0;return"00-0-4-1-000".replace(/[^-]/g,(function(a){return(t[e++]+65536*a>>a).toString(16).padStart(4,"0")}))}function encode(t){for(var e=[],a=0;a<t.length;a++)e[a]=t.charCodeAt(a);return new Uint8Array(e)}var margin={top:0,right:30,bottom:50,left:40},width=1024,height=400,xOffset=10,deltaX=null,deltaY=null,dragX=null,dragY=null,room=null,dataCases=null,color=d3.scaleSequential().domain([0,20]).interpolator(d3.interpolateRainbow),xScale=d3.scaleTime().range([margin.right,width-margin.left]),yScale=d3.scaleBand().range([margin.top,height-margin.bottom]),svg=d3.select(".main-area").append("svg").attr("width",width).attr("height",height).attr("id",uuidv4()).attr("class","gantt-svg").attr("transform","translate("+margin.left+","+margin.top+")"),tooltip=d3.select(".main-area").append("div").attr("class","svg-tooltip").style("position","absolute").style("visibility","hidden");function updateXScaleDomain(t){xScale.domain([new Date("2021-01-01"),new Date("2021-01-31")]).clamp(!0)}function updateYScaleDomain(t){yScale.domain(t.map((function(t){return t.name})))}function scaleBandInvert(t){var e=t.domain(),a=t(e[0]),r=t.step();return function(t){var n=Math.floor((t-a)/r);return e[Math.max(0,Math.min(n,e.length-1))]}}function drawXAxis(){var t=d3.axisBottom().scale(xScale).ticks(d3.utcDay,1).tickFormat(d3.timeFormat("%b %d")).tickSize(12,0,0);svg.append("g").transition().duration(500).attr("transform","translate("+[xOffset,height-margin.bottom]+")").call(t).selectAll("text").attr("transform","rotate(45)").style("text-anchor","start")}function drawYAxis(){var t=d3.axisLeft().scale(yScale);svg.append("g").transition().duration(500).attr("transform","translate("+[margin.left,0]+")").call(t)}function drawVerticalLines(){svg.append("g").selectAll("line").data(xScale.ticks(d3.utcDay,1)).join("line").attr("stroke","#E4E4E4").attr("x1",(function(t){return xScale(new Date(t))+xOffset})).attr("x2",(function(t){return xScale(new Date(t))+xOffset})).attr("y1",margin.top).attr("y2",height-margin.bottom)}function dragStarted(t){var e=d3.select(this).raise().attr("stroke","black");deltaX=e.attr("x")-t.x,dragX=d3.select(this).attr("x"),deltaY=e.attr("y")-t.y,dragY=d3.select(this).attr("y")}function dragged(t,e){var a=xScale(new Date(e.initDate)),r=(xScale(new Date(e.endDate)),margin.right,yScale.bandwidth()),n=(t.x,t.y),i=round(Math.max(0,Math.min(height-r-margin.bottom,n)),r);d3.select(this).attr("y",i),tooltip.style("visibility","hidden")}function round(t,e){return t%e<e/2?t-t%e:t+e-t%e}function dragEnded(t,e){var a=!1,r=parseFloat(d3.select(this).attr("x")),n=parseInt(d3.select(this).attr("y")),i=parseFloat(d3.select(this).attr("width")),o=r+i;if(svg.selectAll(".rect").each((function(t,i){var s=parseFloat(d3.select(this).attr("x")),d=parseInt(d3.select(this).attr("y")),c=s+parseFloat(d3.select(this).attr("width"));a||t.id===e.id||n!==d||(r>=s&&r<c||o>s&&o<=c||r<s&&o>c)&&(a=!0)})),d3.select(this).attr("stroke","#FFFFFF"),a)d3.select(this).attr("y",dragY),a=!1;else{var s=scaleBandInvert(yScale)(t.y);dataCases=d3.map(dataCases,(function(t){return _objectSpread(_objectSpread({},t),t.id===e.id&&{room:s})}))}}function drawBars(t){var e=yScale.bandwidth();svg.selectAll("rect").data(t,(function(t){return t.id})).join((function(t){return t.append("rect").attr("class","rect").attr("fill",(function(t,e){return color(e)})).attr("width",0).attr("height",e).attr("stroke","#FFFFFF").attr("x",(function(t){return xScale(new Date(t.initDate))+1*xOffset})).attr("y",(function(t){return yScale(t.room)})).call((function(t){return t.transition().delay((function(t,e){return 60*e})).attr("width",(function(t){var e=xScale(new Date(t.initDate));return xScale(new Date(t.endDate))-e}))}))}),(function(t){return t.transition().delay((function(t,e){return 60*e})).attr("x",(function(t){return xScale(new Date(t.initDate))+1*xOffset})).attr("width",(function(t){var e=xScale(new Date(t.initDate));return xScale(new Date(t.endDate))-e})).attr("height",e).attr("y",(function(t){return yScale(t.room)}))}),(function(t){return t.transition().delay((function(t,e){return 60*e})).attr("width",0).remove()})).call(d3.drag().on("start",dragStarted).on("drag",dragged).on("end",dragEnded))}function draw(t,e){updateXScaleDomain(e),updateYScaleDomain(t),drawXAxis(),drawYAxis(),drawVerticalLines(),drawBars(e)}function onChange(t){var e=new FileReader;e.onload=onReaderLoad,t.target.files[0]&&e.readAsText(t.target.files[0])}function onReaderLoad(t){var e=JSON.parse(t.target.result);drawBars(dataCases=e.filter((function(t){return room.find((function(e){return e.name===t.room}))})))}Promise.all([d3.json("assets/stubs/rooms.json"),d3.json("assets/stubs/reservations.json")]).then((function(t){room=t[0],dataCases=t[1],draw(room,dataCases)})),$(".input-daterange").datepicker({format:"yyyy-mm-dd",startDate:"2021-01-01",endDate:"2021-01-31",autoclose:!0}),$("#reservation-form").validate({rules:{start:{required:!0},end:{required:!0},room:{required:!0}},messages:{start:"",end:"",room:""},submitHandler:function(t){var e=$("#room").val(),a=$("#start-date").val(),r=$("#end-date").val();dataCases.find((function(t){return t.room===e&&(a>=t.initDate&&a<t.endDate||r>t.initDate&&r<=t.endDate||a<t.initDate&&r>t.endDate)}))?$("#error-modal").modal():(dataCases.push({id:uuidv4(),room:e,initDate:a,endDate:r,name:"XXXXXXXXX"}),drawBars(dataCases))}}),document.getElementById("upload-file").addEventListener("change",onChange);var save=document.getElementById("save-drawing");save.addEventListener("click",(function(){var t=encode(JSON.stringify(dataCases,null,"\t")),e=new Blob([t],{type:"application/octet-stream"}),a=URL.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",a),r.setAttribute("download","reservations.json");var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(n)}));